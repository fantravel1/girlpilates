{{/* Google Analytics 4 - Only loads if ID is configured */}}
{{ with .Site.Params.googleAnalytics }}
{{ if . }}
<!-- Google Analytics 4 -->
<script async src="https://www.googletagmanager.com/gtag/js?id={{ . }}"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', '{{ . }}', {
    'anonymize_ip': true,
    'cookie_flags': 'SameSite=None;Secure'
  });

  // Track outbound links
  document.addEventListener('click', function(e) {
    const link = e.target.closest('a');
    if (link && link.hostname !== window.location.hostname) {
      gtag('event', 'click', {
        'event_category': 'outbound',
        'event_label': link.href,
        'transport_type': 'beacon'
      });
    }
  });

  // Track video plays (YouTube embeds)
  document.addEventListener('liteYouTubeIframeLoaded', function(e) {
    gtag('event', 'video_start', {
      'event_category': 'video',
      'event_label': e.detail.videoId
    });
  });

  // Track search usage
  const searchInput = document.querySelector('[data-search-input]');
  if (searchInput) {
    let searchTimeout;
    searchInput.addEventListener('input', function() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        if (this.value.length > 2) {
          gtag('event', 'search', {
            'search_term': this.value
          });
        }
      }, 1000);
    });
  }

  // Track workout generator usage
  const generateBtn = document.querySelector('[data-generate-workout]');
  if (generateBtn) {
    generateBtn.addEventListener('click', function() {
      gtag('event', 'generate_workout', {
        'event_category': 'engagement'
      });
    });
  }

  // Track workout player starts
  const beginWorkoutBtn = document.querySelector('#begin-workout-btn');
  if (beginWorkoutBtn) {
    beginWorkoutBtn.addEventListener('click', function() {
      gtag('event', 'begin_workout', {
        'event_category': 'engagement',
        'event_label': document.title
      });
    });
  }
</script>
{{ end }}
{{ end }}
