{{ define "main" }}
{{ $premade := site.Data.premade_workouts }}
{{ $categories := $premade.categories }}
{{ $workouts := $premade.workouts }}

<div class="bg-gradient-to-br from-pink-50 via-purple-50 to-pink-50 min-h-screen">
  <!-- Header -->
  <div class="container py-12">
    <div class="max-w-3xl">
      <span class="inline-block px-3 py-1 bg-pink-100 text-pink-700 rounded-full text-sm font-medium mb-4">
        {{ len $workouts }} {{ i18n "ready_workouts" | default "Ready-Made Workouts" }}
      </span>
      <h1 class="text-4xl lg:text-5xl font-bold text-gray-900 mb-4">{{ .Title }}</h1>
      <p class="text-xl text-gray-600">{{ .Description }}</p>
    </div>
  </div>

  <!-- Category Quick Filters -->
  <div class="sticky top-14 lg:top-16 bg-white/95 backdrop-blur border-b border-gray-100 z-20">
    <div class="container py-4">
      <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
        <button data-filter="all" class="filter-btn active flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium bg-pink-600 text-white">
          {{ i18n "all" | default "All" }}
        </button>
        {{ range $categories }}
        <button data-filter="{{ .id }}" class="filter-btn flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200">
          {{ .name }}
        </button>
        {{ end }}
      </div>
    </div>
  </div>

  <div class="container py-8">
    <div class="lg:flex gap-8">
      <!-- Sidebar Filters (Desktop) -->
      <aside class="hidden lg:block w-72 flex-shrink-0">
        <div class="sticky top-36 space-y-6">
          {{ range $categories }}
          <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-100 filter-group" data-category="{{ .id }}">
            <h3 class="font-semibold text-gray-900 mb-3 flex items-center gap-2">
              {{ if eq .icon "location" }}
              <svg class="w-5 h-5 text-pink-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
              {{ else if eq .icon "clock" }}
              <svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              {{ else if eq .icon "heart" }}
              <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
              {{ else if eq .icon "target" }}
              <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
              {{ else if eq .icon "body" }}
              <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
              {{ else if eq .icon "users" }}
              <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
              {{ else if eq .icon "sparkles" }}
              <svg class="w-5 h-5 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/></svg>
              {{ end }}
              {{ .name }}
            </h3>
            <div class="space-y-2">
              {{ range .options }}
              <label class="flex items-center gap-2 text-sm text-gray-600 cursor-pointer hover:text-gray-900">
                <input type="checkbox" class="filter-checkbox rounded border-gray-300 text-pink-600 focus:ring-pink-500" data-category="{{ $.id }}" data-value="{{ .id }}">
                {{ .name }}
              </label>
              {{ end }}
            </div>
          </div>
          {{ end }}

          <button id="clear-filters" class="w-full py-2 text-sm text-pink-600 hover:text-pink-700 font-medium hidden">
            {{ i18n "clear_filters" | default "Clear All Filters" }}
          </button>
        </div>
      </aside>

      <!-- Mobile Filter Panel -->
      <div id="mobile-filter-panel" class="fixed inset-0 bg-black/50 z-50 hidden lg:hidden">
        <div class="absolute right-0 top-0 bottom-0 w-80 max-w-full bg-white overflow-y-auto">
          <div class="sticky top-0 bg-white border-b p-4 flex items-center justify-between">
            <h2 class="font-semibold text-lg">{{ i18n "filters" | default "Filters" }}</h2>
            <button id="close-mobile-filters" class="p-2 hover:bg-gray-100 rounded-lg">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
          </div>
          <div class="p-4 space-y-6">
            {{ range $categories }}
            <div class="filter-group" data-category="{{ .id }}">
              <h3 class="font-semibold text-gray-900 mb-3">{{ .name }}</h3>
              <div class="space-y-2">
                {{ range .options }}
                <label class="flex items-center gap-2 text-sm text-gray-600">
                  <input type="checkbox" class="filter-checkbox-mobile rounded border-gray-300 text-pink-600 focus:ring-pink-500" data-category="{{ $.id }}" data-value="{{ .id }}">
                  {{ .name }}
                </label>
                {{ end }}
              </div>
            </div>
            {{ end }}
          </div>
          <div class="sticky bottom-0 bg-white border-t p-4">
            <button id="apply-mobile-filters" class="w-full btn btn-primary">
              {{ i18n "apply_filters" | default "Apply Filters" }}
            </button>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="flex-1">
        <!-- Mobile Filter Toggle -->
        <div class="lg:hidden mb-6 flex gap-3">
          <button id="open-mobile-filters" class="flex items-center gap-2 px-4 py-2 bg-white rounded-lg border border-gray-200 text-sm font-medium">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/></svg>
            {{ i18n "filters" | default "Filters" }}
          </button>
          <select id="sort-select" class="px-4 py-2 bg-white rounded-lg border border-gray-200 text-sm">
            <option value="featured">{{ i18n "featured" | default "Featured" }}</option>
            <option value="duration-asc">{{ i18n "shortest" | default "Shortest First" }}</option>
            <option value="duration-desc">{{ i18n "longest" | default "Longest First" }}</option>
            <option value="difficulty">{{ i18n "by_difficulty" | default "By Difficulty" }}</option>
          </select>
        </div>

        <!-- Results Count -->
        <div class="flex items-center justify-between mb-6">
          <p id="results-count" class="text-gray-600">
            {{ i18n "showing" | default "Showing" }} <span class="font-medium text-gray-900">{{ len $workouts }}</span> {{ i18n "workouts" | default "workouts" }}
          </p>
          <select id="sort-select-desktop" class="hidden lg:block px-4 py-2 bg-white rounded-lg border border-gray-200 text-sm">
            <option value="featured">{{ i18n "featured" | default "Featured" }}</option>
            <option value="duration-asc">{{ i18n "shortest" | default "Shortest First" }}</option>
            <option value="duration-desc">{{ i18n "longest" | default "Longest First" }}</option>
            <option value="difficulty">{{ i18n "by_difficulty" | default "By Difficulty" }}</option>
          </select>
        </div>

        <!-- Workout Grid -->
        <div id="workout-grid" class="grid gap-6 sm:grid-cols-2 xl:grid-cols-3">
          {{ range $workouts }}
          <article class="workout-card bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-lg transition-all group"
            data-id="{{ .id }}"
            data-duration="{{ .duration }}"
            data-difficulty="{{ .difficulty }}"
            data-featured="{{ .featured }}"
            data-categories='{{ .categories | jsonify }}'
          >
            <!-- Card Header with Gradient -->
            <div class="h-32 bg-gradient-to-br
              {{ if eq .difficulty "beginner" }}from-green-400 to-emerald-500{{ end }}
              {{ if eq .difficulty "intermediate" }}from-yellow-400 to-orange-500{{ end }}
              {{ if eq .difficulty "advanced" }}from-red-400 to-rose-500{{ end }}
              relative overflow-hidden">
              <!-- Duration Badge -->
              <div class="absolute top-3 left-3 bg-white/90 backdrop-blur rounded-full px-3 py-1 text-sm font-medium text-gray-900">
                {{ .duration }} {{ i18n "min" | default "min" }}
              </div>
              <!-- Featured Badge -->
              {{ if .featured }}
              <div class="absolute top-3 right-3 bg-yellow-400 text-yellow-900 rounded-full px-3 py-1 text-xs font-bold">
                {{ i18n "featured" | default "Featured" }}
              </div>
              {{ end }}
              <!-- Decorative Element -->
              <div class="absolute -bottom-8 -right-8 w-32 h-32 bg-white/10 rounded-full"></div>
              <div class="absolute -bottom-4 -right-4 w-20 h-20 bg-white/10 rounded-full"></div>
            </div>

            <!-- Card Content -->
            <div class="p-5">
              <h3 class="text-lg font-semibold text-gray-900 group-hover:text-pink-600 transition-colors mb-2">
                {{ .title }}
              </h3>
              <p class="text-gray-600 text-sm line-clamp-2 mb-4">{{ .description }}</p>

              <!-- Tags -->
              <div class="flex flex-wrap gap-1.5 mb-4">
                {{ with .categories.mood }}
                {{ range (first 1 .) }}
                <span class="px-2 py-0.5 bg-red-50 text-red-700 text-xs rounded-full">{{ . }}</span>
                {{ end }}
                {{ end }}
                {{ with .categories.goal }}
                {{ range (first 1 .) }}
                <span class="px-2 py-0.5 bg-green-50 text-green-700 text-xs rounded-full">{{ . }}</span>
                {{ end }}
                {{ end }}
                {{ with .categories.environment }}
                {{ range (first 1 .) }}
                <span class="px-2 py-0.5 bg-blue-50 text-blue-700 text-xs rounded-full">{{ . }}</span>
                {{ end }}
                {{ end }}
              </div>

              <!-- Footer -->
              <div class="flex items-center justify-between pt-3 border-t border-gray-100">
                <div class="flex items-center gap-2">
                  <span class="text-xs px-2 py-0.5 rounded-full
                    {{ if eq .difficulty "beginner" }}bg-green-100 text-green-700{{ end }}
                    {{ if eq .difficulty "intermediate" }}bg-yellow-100 text-yellow-700{{ end }}
                    {{ if eq .difficulty "advanced" }}bg-red-100 text-red-700{{ end }}
                  ">{{ .difficulty | title }}</span>
                  {{ with .equipment }}
                  <span class="text-xs text-gray-500">{{ delimit . ", " }}</span>
                  {{ end }}
                </div>
                <a href="{{ printf "/workouts/premade/%s/" $.id | relLangURL }}" class="text-pink-600 hover:text-pink-700 font-medium text-sm flex items-center gap-1">
                  {{ i18n "start" | default "Start" }}
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                </a>
              </div>
            </div>
          </article>
          {{ end }}
        </div>

        <!-- No Results Message -->
        <div id="no-results" class="hidden text-center py-16">
          <div class="w-16 h-16 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
            <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          </div>
          <h3 class="text-lg font-semibold text-gray-900 mb-2">{{ i18n "no_workouts_found" | default "No workouts found" }}</h3>
          <p class="text-gray-600 mb-4">{{ i18n "try_different_filters" | default "Try adjusting your filters" }}</p>
          <button id="reset-filters" class="text-pink-600 hover:text-pink-700 font-medium">
            {{ i18n "clear_filters" | default "Clear All Filters" }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const workoutCards = document.querySelectorAll('.workout-card');
  const filterBtns = document.querySelectorAll('.filter-btn');
  const filterCheckboxes = document.querySelectorAll('.filter-checkbox, .filter-checkbox-mobile');
  const sortSelects = document.querySelectorAll('#sort-select, #sort-select-desktop');
  const resultsCount = document.querySelector('#results-count span');
  const noResults = document.getElementById('no-results');
  const workoutGrid = document.getElementById('workout-grid');
  const clearFiltersBtn = document.getElementById('clear-filters');
  const resetFiltersBtn = document.getElementById('reset-filters');

  // Mobile filter panel
  const mobilePanel = document.getElementById('mobile-filter-panel');
  const openMobileBtn = document.getElementById('open-mobile-filters');
  const closeMobileBtn = document.getElementById('close-mobile-filters');
  const applyMobileBtn = document.getElementById('apply-mobile-filters');

  let activeCategory = 'all';
  let activeFilters = {};

  // Quick filter buttons
  filterBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      filterBtns.forEach(b => b.classList.remove('active', 'bg-pink-600', 'text-white'));
      filterBtns.forEach(b => b.classList.add('bg-gray-100', 'text-gray-700'));
      this.classList.add('active', 'bg-pink-600', 'text-white');
      this.classList.remove('bg-gray-100', 'text-gray-700');
      activeCategory = this.dataset.filter;
      applyFilters();
    });
  });

  // Checkbox filters
  filterCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      const category = this.dataset.category;
      const value = this.dataset.value;

      if (!activeFilters[category]) activeFilters[category] = [];

      if (this.checked) {
        if (!activeFilters[category].includes(value)) {
          activeFilters[category].push(value);
        }
      } else {
        activeFilters[category] = activeFilters[category].filter(v => v !== value);
        if (activeFilters[category].length === 0) delete activeFilters[category];
      }

      // Sync checkboxes
      document.querySelectorAll(`input[data-category="${category}"][data-value="${value}"]`).forEach(cb => {
        cb.checked = this.checked;
      });

      applyFilters();
    });
  });

  // Sort functionality
  sortSelects.forEach(select => {
    select.addEventListener('change', function() {
      sortSelects.forEach(s => s.value = this.value);
      applyFilters();
    });
  });

  // Mobile filter panel
  if (openMobileBtn) {
    openMobileBtn.addEventListener('click', () => mobilePanel.classList.remove('hidden'));
  }
  if (closeMobileBtn) {
    closeMobileBtn.addEventListener('click', () => mobilePanel.classList.add('hidden'));
  }
  if (applyMobileBtn) {
    applyMobileBtn.addEventListener('click', () => mobilePanel.classList.add('hidden'));
  }

  // Clear filters
  function clearAllFilters() {
    activeCategory = 'all';
    activeFilters = {};
    filterBtns.forEach(b => b.classList.remove('active', 'bg-pink-600', 'text-white'));
    filterBtns.forEach(b => b.classList.add('bg-gray-100', 'text-gray-700'));
    document.querySelector('[data-filter="all"]').classList.add('active', 'bg-pink-600', 'text-white');
    document.querySelector('[data-filter="all"]').classList.remove('bg-gray-100', 'text-gray-700');
    filterCheckboxes.forEach(cb => cb.checked = false);
    applyFilters();
  }

  if (clearFiltersBtn) clearFiltersBtn.addEventListener('click', clearAllFilters);
  if (resetFiltersBtn) resetFiltersBtn.addEventListener('click', clearAllFilters);

  function applyFilters() {
    const sortValue = document.querySelector('#sort-select-desktop')?.value || 'featured';
    let visibleCount = 0;
    const cardsArray = Array.from(workoutCards);

    // Filter
    cardsArray.forEach(card => {
      const categories = JSON.parse(card.dataset.categories);
      let visible = true;

      // Category quick filter
      if (activeCategory !== 'all') {
        visible = categories[activeCategory] && categories[activeCategory].length > 0;
      }

      // Checkbox filters
      if (visible && Object.keys(activeFilters).length > 0) {
        for (const [cat, values] of Object.entries(activeFilters)) {
          if (!categories[cat] || !values.some(v => categories[cat].includes(v))) {
            visible = false;
            break;
          }
        }
      }

      card.style.display = visible ? '' : 'none';
      if (visible) visibleCount++;
    });

    // Sort visible cards
    const sortedCards = cardsArray.filter(c => c.style.display !== 'none').sort((a, b) => {
      switch(sortValue) {
        case 'duration-asc':
          return parseInt(a.dataset.duration) - parseInt(b.dataset.duration);
        case 'duration-desc':
          return parseInt(b.dataset.duration) - parseInt(a.dataset.duration);
        case 'difficulty':
          const diff = { beginner: 1, intermediate: 2, advanced: 3 };
          return diff[a.dataset.difficulty] - diff[b.dataset.difficulty];
        case 'featured':
        default:
          return (b.dataset.featured === 'true' ? 1 : 0) - (a.dataset.featured === 'true' ? 1 : 0);
      }
    });

    // Reorder in DOM
    sortedCards.forEach(card => workoutGrid.appendChild(card));

    // Update count
    resultsCount.textContent = visibleCount;

    // Show/hide no results
    noResults.classList.toggle('hidden', visibleCount > 0);
    workoutGrid.classList.toggle('hidden', visibleCount === 0);

    // Show/hide clear button
    const hasFilters = activeCategory !== 'all' || Object.keys(activeFilters).length > 0;
    if (clearFiltersBtn) clearFiltersBtn.classList.toggle('hidden', !hasFilters);
  }
});
</script>
{{ end }}
